import telebot
from telebot import types
import datetime
import json
import os

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
bot = telebot.TeleBot('8023981552:AAG3_oU0bn2fTGglgLmTex4VckP1tqEwRVA')

# –§–∞–π–ª—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
DATA_FILE = 'user_data.json'
SUBJECTS_FILE = 'subjects_database.json'

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –∏ —Ç–µ–º (–æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
SUBJECTS_DATABASE = {
    "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞": {
        "5 –∫–ª–∞—Å—Å": ["–ù–∞—Ç—É—Ä–∞–ª—å–Ω—ã–µ —á–∏—Å–ª–∞", "–î—Ä–æ–±–∏", "–î–µ—Å—è—Ç–∏—á–Ω—ã–µ –¥—Ä–æ–±–∏", "–ì–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ —Ñ–∏–≥—É—Ä—ã", "–ü–ª–æ—â–∞–¥–∏ –∏ –æ–±—ä–µ–º—ã"],
        "6 –∫–ª–∞—Å—Å": ["–û–±—ã–∫–Ω–æ–≤–µ–Ω–Ω—ã–µ –¥—Ä–æ–±–∏", "–†–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —á–∏—Å–ª–∞", "–ü—Ä–æ–ø–æ—Ä—Ü–∏–∏", "–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω–∞—è –ø–ª–æ—Å–∫–æ—Å—Ç—å",
                    "–≠–ª–µ–º–µ–Ω—Ç—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"],
        "7 –∫–ª–∞—Å—Å": ["–ê–ª–≥–µ–±—Ä–∞–∏—á–µ—Å–∫–∏–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è", "–õ–∏–Ω–µ–π–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è", "–§—É–Ω–∫—Ü–∏–∏", "–ù–∞—á–∞–ª–∞ –≥–µ–æ–º–µ—Ç—Ä–∏–∏", "–¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∏"],
        "8 –∫–ª–∞—Å—Å": ["–ö–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è", "–ù–µ—Ä–∞–≤–µ–Ω—Å—Ç–≤–∞", "–ö–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ –∫–æ—Ä–Ω–∏", "–ß–µ—Ç—ã—Ä–µ—Ö—É–≥–æ–ª—å–Ω–∏–∫–∏", "–û–∫—Ä—É–∂–Ω–æ—Å—Ç—å"],
        "9 –∫–ª–∞—Å—Å": ["–°–∏—Å—Ç–µ–º—ã —É—Ä–∞–≤–Ω–µ–Ω–∏–π", "–ü—Ä–æ–≥—Ä–µ—Å—Å–∏–∏", "–≠–ª–µ–º–µ–Ω—Ç—ã –∫–æ–º–±–∏–Ω–∞—Ç–æ—Ä–∏–∫–∏", "–í–µ–∫—Ç–æ—Ä—ã", "–¢–µ–æ—Ä–∏—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π"],
        "10-11 –∫–ª–∞—Å—Å": ["–¢—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—è", "–ü—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è", "–ò–Ω—Ç–µ–≥—Ä–∞–ª—ã", "–°—Ç–µ—Ä–µ–æ–º–µ—Ç—Ä–∏—è", "–õ–æ–≥–∞—Ä–∏—Ñ–º—ã", "–ü—Ä–µ–¥–µ–ª—ã"]
    },
    "–†—É—Å—Å–∫–∏–π —è–∑—ã–∫": {
        "5 –∫–ª–∞—Å—Å": ["–§–æ–Ω–µ—Ç–∏–∫–∞", "–õ–µ–∫—Å–∏–∫–∞", "–ú–æ—Ä—Ñ–µ–º–∏–∫–∞", "–ò–º—è —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–µ", "–ò–º—è –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω–æ–µ"],
        "6 –∫–ª–∞—Å—Å": ["–ì–ª–∞–≥–æ–ª", "–ü—Ä–∏—á–∞—Å—Ç–∏–µ", "–î–µ–µ–ø—Ä–∏—á–∞—Å—Ç–∏–µ", "–ù–∞—Ä–µ—á–∏–µ", "–ú–µ—Å—Ç–æ–∏–º–µ–Ω–∏–µ"],
        "7 –∫–ª–∞—Å—Å": ["–°–ª—É–∂–µ–±–Ω—ã–µ —á–∞—Å—Ç–∏ —Ä–µ—á–∏", "–ü—Ä–µ–¥–ª–æ–≥", "–°–æ—é–∑", "–ß–∞—Å—Ç–∏—Ü–∞", "–ú–µ–∂–¥–æ–º–µ—Ç–∏–µ"],
        "8 –∫–ª–∞—Å—Å": ["–°–∏–Ω—Ç–∞–∫—Å–∏—Å", "–ü–æ–¥–ª–µ–∂–∞—â–µ–µ –∏ —Å–∫–∞–∑—É–µ–º–æ–µ", "–í—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–µ —á–ª–µ–Ω—ã", "–û–¥–Ω–æ—Å–æ—Å—Ç–∞–≤–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è"],
        "9 –∫–ª–∞—Å—Å": ["–°–ª–æ–∂–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ", "–°–ª–æ–∂–Ω–æ—Å–æ—á–∏–Ω–µ–Ω–Ω—ã–µ", "–°–ª–æ–∂–Ω–æ–ø–æ–¥—á–∏–Ω–µ–Ω–Ω—ã–µ", "–ë–µ—Å—Å–æ—é–∑–Ω—ã–µ"],
        "10-11 –∫–ª–∞—Å—Å": ["–¢–µ–∫—Å—Ç –∏ –µ–≥–æ —Å—Ç—Ä–æ–µ–Ω–∏–µ", "–°—Ç–∏–ª–∏ —Ä–µ—á–∏", "–ù–æ—Ä–º—ã –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω–æ–≥–æ —è–∑—ã–∫–∞", "–í—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞"]
    },
    "–§–∏–∑–∏–∫–∞": {
        "7 –∫–ª–∞—Å—Å": ["–ú–µ—Ö–∞–Ω–∏–∫–∞", "–ö–∏–Ω–µ–º–∞—Ç–∏–∫–∞", "–î–∏–Ω–∞–º–∏–∫–∞", "–°—Ç–∞—Ç–∏–∫–∞", "–î–∞–≤–ª–µ–Ω–∏–µ"],
        "8 –∫–ª–∞—Å—Å": ["–¢–µ–ø–ª–æ–≤—ã–µ —è–≤–ª–µ–Ω–∏—è", "–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ", "–ú–∞–≥–Ω–µ—Ç–∏–∑–º", "–°–≤–µ—Ç–æ–≤—ã–µ —è–≤–ª–µ–Ω–∏—è", "–û–ø—Ç–∏–∫–∞"],
        "9 –∫–ª–∞—Å—Å": ["–ó–∞–∫–æ–Ω—ã –ù—å—é—Ç–æ–Ω–∞", "–ó–∞–∫–æ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è", "–ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏–µ –∫–æ–ª–µ–±–∞–Ω–∏—è", "–≠–ª–µ–∫—Ç—Ä–æ–º–∞–≥–Ω–∏—Ç–Ω—ã–µ —è–≤–ª–µ–Ω–∏—è"],
        "10 –∫–ª–∞—Å—Å": ["–ú–æ–ª–µ–∫—É–ª—è—Ä–Ω–∞—è —Ñ–∏–∑–∏–∫–∞", "–¢–µ—Ä–º–æ–¥–∏–Ω–∞–º–∏–∫–∞", "–≠–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞—Ç–∏–∫–∞", "–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π —Ç–æ–∫"],
        "11 –∫–ª–∞—Å—Å": ["–≠–ª–µ–∫—Ç—Ä–æ–¥–∏–Ω–∞–º–∏–∫–∞", "–ö–≤–∞–Ω—Ç–æ–≤–∞—è —Ñ–∏–∑–∏–∫–∞", "–Ø–¥–µ—Ä–Ω–∞—è —Ñ–∏–∑–∏–∫–∞", "–ê—Å—Ç—Ä–æ—Ñ–∏–∑–∏–∫–∞", "–û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å"]
    },
    "–•–∏–º–∏—è": {
        "8 –∫–ª–∞—Å—Å": ["–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è", "–°—Ç—Ä–æ–µ–Ω–∏–µ –∞—Ç–æ–º–∞", "–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –∑–∞–∫–æ–Ω", "–•–∏–º–∏—á–µ—Å–∫–∞—è —Å–≤—è–∑—å", "–ö–ª–∞—Å—Å—ã –≤–µ—â–µ—Å—Ç–≤"],
        "9 –∫–ª–∞—Å—Å": ["–•–∏–º–∏—á–µ—Å–∫–∏–µ —Ä–µ–∞–∫—Ü–∏–∏", "–†–∞—Å—Ç–≤–æ—Ä—ã", "–ú–µ—Ç–∞–ª–ª—ã", "–ù–µ–º–µ—Ç–∞–ª–ª—ã", "–û—Ä–≥–∞–Ω–∏—á–µ—Å–∫–∞—è —Ö–∏–º–∏—è"],
        "10 –∫–ª–∞—Å—Å": ["–£–≥–ª–µ–≤–æ–¥–æ—Ä–æ–¥—ã", "–°–ø–∏—Ä—Ç—ã –∏ —Ñ–µ–Ω–æ–ª—ã", "–ê–ª—å–¥–µ–≥–∏–¥—ã –∏ –∫–µ—Ç–æ–Ω—ã", "–ö–∞—Ä–±–æ–Ω–æ–≤—ã–µ –∫–∏—Å–ª–æ—Ç—ã", "–ê–º–∏–Ω—ã"],
        "11 –∫–ª–∞—Å—Å": ["–°—Ç—Ä–æ–µ–Ω–∏–µ –≤–µ—â–µ—Å—Ç–≤–∞", "–•–∏–º–∏—á–µ—Å–∫–∞—è –∫–∏–Ω–µ—Ç–∏–∫–∞", "–•–∏–º–∏—á–µ—Å–∫–æ–µ —Ä–∞–≤–Ω–æ–≤–µ—Å–∏–µ", "–≠–ª–µ–∫—Ç—Ä–æ—Ö–∏–º–∏—è", "–ü–æ–ª–∏–º–µ—Ä—ã"]
    },
    "–ò—Å—Ç–æ—Ä–∏—è": {
        "5 –∫–ª–∞—Å—Å": ["–î—Ä–µ–≤–Ω–∏–π –º–∏—Ä", "–î—Ä–µ–≤–Ω–∏–π –í–æ—Å—Ç–æ–∫", "–ê–Ω—Ç–∏—á–Ω–æ—Å—Ç—å", "–î—Ä–µ–≤–Ω—è—è –†—É—Å—å"],
        "6 –∫–ª–∞—Å—Å": ["–°—Ä–µ–¥–Ω–µ–≤–µ–∫–æ–≤—å–µ", "–ö–∏–µ–≤—Å–∫–∞—è –†—É—Å—å", "–ú–æ–Ω–≥–æ–ª—å—Å–∫–æ–µ –Ω–∞—à–µ—Å—Ç–≤–∏–µ", "–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤"],
        "7 –∫–ª–∞—Å—Å": ["–ù–æ–≤–æ–µ –≤—Ä–µ–º—è", "–≠–ø–æ—Ö–∞ –í–æ–∑—Ä–æ–∂–¥–µ–Ω–∏—è", "–†–µ—Ñ–æ—Ä–º–∞—Ü–∏—è", "–°–º—É—Ç–Ω–æ–µ –≤—Ä–µ–º—è"],
        "8 –∫–ª–∞—Å—Å": ["18 –≤–µ–∫", "–≠–ø–æ—Ö–∞ –ü—Ä–æ—Å–≤–µ—â–µ–Ω–∏—è", "–í–µ–ª–∏–∫–∏–µ —Ä–µ–≤–æ–ª—é—Ü–∏–∏", "–†–æ—Å—Å–∏–π—Å–∫–∞—è –∏–º–ø–µ—Ä–∏—è"],
        "9 –∫–ª–∞—Å—Å": ["19 –≤–µ–∫", "–ù–∞–ø–æ–ª–µ–æ–Ω–æ–≤—Å–∫–∏–µ –≤–æ–π–Ω—ã", "–û—Ç–º–µ–Ω–∞ –∫—Ä–µ–ø–æ—Å—Ç–Ω–æ–≥–æ –ø—Ä–∞–≤–∞", "–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–∞—è —Ä–µ–≤–æ–ª—é—Ü–∏—è"],
        "10-11 –∫–ª–∞—Å—Å": ["20 –≤–µ–∫", "–ú–∏—Ä–æ–≤—ã–µ –≤–æ–π–Ω—ã", "–•–æ–ª–æ–¥–Ω–∞—è –≤–æ–π–Ω–∞", "–°–æ–≤—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å"]
    },
    "–ë–∏–æ–ª–æ–≥–∏—è": {
        "5 –∫–ª–∞—Å—Å": ["–ñ–∏–≤—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–º—ã", "–†–∞—Å—Ç–µ–Ω–∏—è", "–ì—Ä–∏–±—ã", "–ë–∞–∫—Ç–µ—Ä–∏–∏", "–°—Ç—Ä–æ–µ–Ω–∏–µ –∫–ª–µ—Ç–∫–∏"],
        "6 –∫–ª–∞—Å—Å": ["–ë–æ—Ç–∞–Ω–∏–∫–∞", "–§–æ—Ç–æ—Å–∏–Ω—Ç–µ–∑", "–†–∞–∑–º–Ω–æ–∂–µ–Ω–∏–µ —Ä–∞—Å—Ç–µ–Ω–∏–π", "–≠–∫–æ–ª–æ–≥–∏—è —Ä–∞—Å—Ç–µ–Ω–∏–π"],
        "7 –∫–ª–∞—Å—Å": ["–ó–æ–æ–ª–æ–≥–∏—è", "–ë–µ—Å–ø–æ–∑–≤–æ–Ω–æ—á–Ω—ã–µ", "–ü–æ–∑–≤–æ–Ω–æ—á–Ω—ã–µ", "–≠–≤–æ–ª—é—Ü–∏—è –∂–∏–≤–æ—Ç–Ω—ã—Ö"],
        "8 –∫–ª–∞—Å—Å": ["–ê–Ω–∞—Ç–æ–º–∏—è", "–°–∏—Å—Ç–µ–º—ã –æ—Ä–≥–∞–Ω–æ–≤", "–ì–∏–≥–∏–µ–Ω–∞", "–ù–µ–π—Ä–æ–≥—É–º–æ—Ä–∞–ª—å–Ω–∞—è —Ä–µ–≥—É–ª—è—Ü–∏—è"],
        "9 –∫–ª–∞—Å—Å": ["–ì–µ–Ω–µ—Ç–∏–∫–∞", "–°–µ–ª–µ–∫—Ü–∏—è", "–ë–∏–æ—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏", "–¶–∏—Ç–æ–ª–æ–≥–∏—è"],
        "10-11 –∫–ª–∞—Å—Å": ["–ú–æ–ª–µ–∫—É–ª—è—Ä–Ω–∞—è –±–∏–æ–ª–æ–≥–∏—è", "–≠–≤–æ–ª—é—Ü–∏–æ–Ω–Ω–æ–µ —É—á–µ–Ω–∏–µ", "–≠–∫–æ–ª–æ–≥–∏—è", "–ë–∏–æ—Ö–∏–º–∏—è"]
    },
    "–û–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏–µ": {
        "6 –∫–ª–∞—Å—Å": ["–ß–µ–ª–æ–≤–µ–∫ –∏ –æ–±—â–µ—Å—Ç–≤–æ", "–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ –Ω–æ—Ä–º—ã", "–°–µ–º—å—è", "–®–∫–æ–ª–∞"],
        "7 –∫–ª–∞—Å—Å": ["–≠–∫–æ–Ω–æ–º–∏–∫–∞", "–ü–æ–ª–∏—Ç–∏–∫–∞", "–ü—Ä–∞–≤–æ", "–ö—É–ª—å—Ç—É—Ä–∞"],
        "8 –∫–ª–∞—Å—Å": ["–õ–∏—á–Ω–æ—Å—Ç—å –∏ –æ–±—â–µ—Å—Ç–≤–æ", "–°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ñ–µ—Ä–∞", "–ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞", "–ü—Ä–∞–≤–æ–≤–æ–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–æ"],
        "9 –∫–ª–∞—Å—Å": ["–≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ —Å–∏—Å—Ç–µ–º—ã", "–†—ã–Ω–æ–∫", "–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–æ", "–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è"],
        "10-11 –∫–ª–∞—Å—Å": ["–§–∏–ª–æ—Å–æ—Ñ–∏—è", "–°–æ—Ü–∏–æ–ª–æ–≥–∏—è", "–ü–æ–ª–∏—Ç–æ–ª–æ–≥–∏—è", "–ü—Ä–∞–≤–æ–≤–µ–¥–µ–Ω–∏–µ"]
    },
    "–ì–µ–æ–≥—Ä–∞—Ñ–∏—è": {
        "5 –∫–ª–∞—Å—Å": ["–ü–ª–∞–Ω –∏ –∫–∞—Ä—Ç–∞", "–û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ", "–ó–µ–º–ª—è –∫–∞–∫ –ø–ª–∞–Ω–µ—Ç–∞", "–ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –æ—Ç–∫—Ä—ã—Ç–∏—è"],
        "6 –∫–ª–∞—Å—Å": ["–õ–∏—Ç–æ—Å—Ñ–µ—Ä–∞", "–ì–∏–¥—Ä–æ—Å—Ñ–µ—Ä–∞", "–ê—Ç–º–æ—Å—Ñ–µ—Ä–∞", "–ë–∏–æ—Å—Ñ–µ—Ä–∞"],
        "7 –∫–ª–∞—Å—Å": ["–ú–∞—Ç–µ—Ä–∏–∫–∏ –∏ –æ–∫–µ–∞–Ω—ã", "–ü—Ä–∏—Ä–æ–¥–Ω—ã–µ –∑–æ–Ω—ã", "–ù–∞—Ä–æ–¥—ã –∏ —Å—Ç—Ä–∞–Ω—ã", "–ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è –æ–±–æ–ª–æ—á–∫–∞"],
        "8-9 –∫–ª–∞—Å—Å": ["–ì–µ–æ–≥—Ä–∞—Ñ–∏—è –†–æ—Å—Å–∏–∏", "–ü—Ä–∏—Ä–æ–¥–∞ –†–æ—Å—Å–∏–∏", "–ù–∞—Å–µ–ª–µ–Ω–∏–µ –†–æ—Å—Å–∏–∏", "–•–æ–∑—è–π—Å—Ç–≤–æ –†–æ—Å—Å–∏–∏"],
        "10-11 –∫–ª–∞—Å—Å": ["–≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∞—è –≥–µ–æ–≥—Ä–∞—Ñ–∏—è", "–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã", "–ú–∏—Ä–æ–≤–æ–µ —Ö–æ–∑—è–π—Å—Ç–≤–æ", "–ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–æ–≥—Ä–∞—Ñ–∏—è"]
    },
    "–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞": {
        "5 –∫–ª–∞—Å—Å": ["–£—Å—Ç–Ω–æ–µ –Ω–∞—Ä–æ–¥–Ω–æ–µ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ", "–î—Ä–µ–≤–Ω–µ—Ä—É—Å—Å–∫–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞", "–†—É—Å—Å–∫–∏–µ –ø–∏—Å–∞—Ç–µ–ª–∏ 19 –≤–µ–∫–∞", "–ü–æ—ç–∑–∏—è"],
        "6 –∫–ª–∞—Å—Å": ["–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞ 18 –≤–µ–∫–∞", "–ó–æ–ª–æ—Ç–æ–π –≤–µ–∫ —Ä—É—Å—Å–∫–æ–π –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã", "–ü–æ—ç–∑–∏—è 19 –≤–µ–∫–∞", "–ë–∞—Å–Ω–∏"],
        "7 –∫–ª–∞—Å—Å": ["–†–µ–∞–ª–∏–∑–º –≤ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–µ", "–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ –ü—É—à–∫–∏–Ω–∞", "–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ –õ–µ—Ä–º–æ–Ω—Ç–æ–≤–∞", "–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ –ì–æ–≥–æ–ª—è"],
        "8 –∫–ª–∞—Å—Å": ["–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞ 19 –≤–µ–∫–∞", "–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ –¢—É—Ä–≥–µ–Ω–µ–≤–∞", "–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ –¢–æ–ª—Å—Ç–æ–≥–æ", "–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ –î–æ—Å—Ç–æ–µ–≤—Å–∫–æ–≥–æ"],
        "9 –∫–ª–∞—Å—Å": ["–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞ 20 –≤–µ–∫–∞", "–°–µ—Ä–µ–±—Ä—è–Ω—ã–π –≤–µ–∫", "–°–æ–≤–µ—Ç—Å–∫–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞", "–°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞"]
    },
    "–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞": {
        "7 –∫–ª–∞—Å—Å": ["–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ –¥–∞–Ω–Ω—ã–µ", "–ê–ª–≥–æ—Ä–∏—Ç–º—ã", "–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ", "–ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ —Å–µ—Ç–∏"],
        "8 –∫–ª–∞—Å—Å": ["–°–∏—Å—Ç–µ–º—ã —Å—á–∏—Å–ª–µ–Ω–∏—è", "–õ–æ–≥–∏–∫–∞", "–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö", "Web-—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏"],
        "9 –∫–ª–∞—Å—Å": ["–Ø–∑—ã–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è", "–ê–ª–≥–æ—Ä–∏—Ç–º–∏–∑–∞—Ü–∏—è", "–°—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö", "–ö–æ–º–ø—å—é—Ç–µ—Ä–Ω–∞—è –≥—Ä–∞—Ñ–∏–∫–∞"],
        "10-11 –∫–ª–∞—Å—Å": ["–û–±—ä–µ–∫—Ç–Ω–æ-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ", "–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö", "–ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ —Å–µ—Ç–∏",
                        "–ö–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å"]
    },
    "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫": {
        "5 –∫–ª–∞—Å—Å": ["–í—Ä–µ–º–µ–Ω–∞ Present", "–ê—Ä—Ç–∏–∫–ª–∏", "–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ", "–û—Å–Ω–æ–≤–Ω–∞—è –ª–µ–∫—Å–∏–∫–∞"],
        "6 –∫–ª–∞—Å—Å": ["–í—Ä–µ–º–µ–Ω–∞ Past", "–ú–æ–¥–∞–ª—å–Ω—ã–µ –≥–ª–∞–≥–æ–ª—ã", "–°—Ç–µ–ø–µ–Ω–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è", "–ë—ã—Ç–æ–≤–∞—è –ª–µ–∫—Å–∏–∫–∞"],
        "7 –∫–ª–∞—Å—Å": ["–í—Ä–µ–º–µ–Ω–∞ Future", "–£—Å–ª–æ–≤–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è", "–ü–∞—Å—Å–∏–≤–Ω—ã–π –∑–∞–ª–æ–≥", "–î–µ–ª–æ–≤–∞—è –ª–µ–∫—Å–∏–∫–∞"],
        "8 –∫–ª–∞—Å—Å": ["–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω", "–ö–æ—Å–≤–µ–Ω–Ω–∞—è —Ä–µ—á—å", "–§—Ä–∞–∑–æ–≤—ã–µ –≥–ª–∞–≥–æ–ª—ã", "–ê–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∞—è –ª–µ–∫—Å–∏–∫–∞"],
        "9-11 –∫–ª–∞—Å—Å": ["–í—Å–µ –≤—Ä–µ–º–µ–Ω–∞", "–°—Ç–∏–ª–∏—Å—Ç–∏–∫–∞", "–ò–¥–∏–æ–º—ã", "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —ç–∫–∑–∞–º–µ–Ω–∞–º"]
    },
    "–ù–µ–º–µ—Ü–∫–∏–π —è–∑—ã–∫": {
        "5 –∫–ª–∞—Å—Å": ["–ê—Ä—Ç–∏–∫–ª–∏", "–°–ø—Ä—è–∂–µ–Ω–∏–µ –≥–ª–∞–≥–æ–ª–æ–≤", "–ü–∞–¥–µ–∂–∏", "–û—Å–Ω–æ–≤–Ω–∞—è –ª–µ–∫—Å–∏–∫–∞"],
        "6 –∫–ª–∞—Å—Å": ["–í—Ä–µ–º–µ–Ω–∞", "–ü—Ä–µ–¥–ª–æ–≥–∏", "–°–ª–æ–∂–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è", "–ë—ã—Ç–æ–≤–∞—è –ª–µ–∫—Å–∏–∫–∞"],
        "7 –∫–ª–∞—Å—Å": ["–ü–∞—Å—Å–∏–≤", "–ü—Ä–∏–¥–∞—Ç–æ—á–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è", "–ú–æ–¥–∞–ª—å–Ω—ã–µ –≥–ª–∞–≥–æ–ª—ã", "–î–µ–ª–æ–≤–∞—è –ª–µ–∫—Å–∏–∫–∞"],
        "8-11 –∫–ª–∞—Å—Å": ["–í—Å–µ –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ–º—ã", "–°—Ç–∏–ª–∏—Å—Ç–∏–∫–∞", "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —ç–∫–∑–∞–º–µ–Ω–∞–º"]
    }
}


# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏–º–≤–æ–ª–æ–≤ Markdown
def escape_markdown(text):
    if not text:
        return ""
    # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–∏–º–≤–æ–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞–Ω—ã –∫–∞–∫ Markdown
    escape_chars = ['_', '*', '[', ']', '(', ')', '~', '`', '>', '#', '+', '-', '=', '|', '{', '}', '.', '!']
    for char in escape_chars:
        text = text.replace(char, '\\' + char)
    return text


# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤
def save_subjects_database():
    with open(SUBJECTS_FILE, 'w', encoding='utf-8') as f:
        json.dump(SUBJECTS_DATABASE, f, ensure_ascii=False, indent=2)


# –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
def load_data():
    if os.path.exists(DATA_FILE):
        with open(DATA_FILE, 'r', encoding='utf-8') as f:
            return json.load(f)
    return {}


# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
def save_data(data):
    with open(DATA_FILE, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=2)


# –ö–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —É—á–µ–±–Ω—ã–º–∏ –ø–ª–∞–Ω–∞–º–∏
class StudyPlanGenerator:
    def __init__(self):
        self.user_data = load_data()

    def save_user_plan(self, user_id, plan_data):
        self.user_data[str(user_id)] = plan_data
        save_data(self.user_data)

    def get_user_plan(self, user_id):
        return self.user_data.get(str(user_id))

    def generate_study_plan(self, subject, topic, exam_date, daily_time, user_id):
        try:
            # –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞—Ç—ã —ç–∫–∑–∞–º–µ–Ω–∞
            exam_date_obj = datetime.datetime.strptime(exam_date, '%d.%m.%Y')
            today = datetime.datetime.now()

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –¥–∞—Ç—ã
            if exam_date_obj <= today:
                return "‚ùå –î–∞—Ç–∞ —ç–∫–∑–∞–º–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ –±—É–¥—É—â–µ–º!"

            # –†–∞—Å—á–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–Ω–µ–π –¥–æ —ç–∫–∑–∞–º–µ–Ω–∞
            days_until_exam = (exam_date_obj - today).days

            if days_until_exam <= 0:
                return "‚ùå –î–æ —ç–∫–∑–∞–º–µ–Ω–∞ –æ—Å—Ç–∞–ª–æ—Å—å —Å–ª–∏—à–∫–æ–º –º–∞–ª–æ –¥–Ω–µ–π!"

            # –†–∞—Å—á–µ—Ç –æ–±—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É
            total_study_minutes = days_until_exam * daily_time

            # –†–∞–∑–±–∏–≤–∫–∞ —Ç–µ–º—ã –Ω–∞ –ø–æ–¥—Ç–µ–º—ã
            subtopics = self.split_topic_into_subtopics(subject, topic)

            # –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ –ø–æ–¥—Ç–µ–º–∞–º
            plan = self.distribute_study_time(subtopics, total_study_minutes, days_until_exam)

            # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–∞
            study_plan = self.format_study_plan(plan, subject, topic, exam_date, daily_time, days_until_exam)

            # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            plan_data = {
                'subject': subject,
                'topic': topic,
                'exam_date': exam_date,
                'daily_time': daily_time,
                'plan': study_plan,
                'created_at': datetime.datetime.now().strftime('%d.%m.%Y %H:%M')
            }
            self.save_user_plan(user_id, plan_data)

            return study_plan

        except ValueError as e:
            return "‚ùå –û—à–∏–±–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –¥–∞—Ç—ã! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì"
        except Exception as e:
            return f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {str(e)}"

    def split_topic_into_subtopics(self, subject, topic):
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ç–µ–º—ã –¥–ª—è –ø—Ä–µ–¥–º–µ—Ç–∞
        all_topics = []
        for grade, topics in SUBJECTS_DATABASE.get(subject, {}).items():
            all_topics.extend(topics)

        # –ï—Å–ª–∏ —Ç–µ–º–∞ –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–∞–∑–µ, —Å–æ–∑–¥–∞–µ–º –ø–æ–¥—Ç–µ–º—ã –Ω–∞ –µ–µ –æ—Å–Ω–æ–≤–µ
        if topic in all_topics:
            # –ë–∞–∑–æ–≤—ã–µ –ø–æ–¥—Ç–µ–º—ã –¥–ª—è –ª—é–±–æ–π —Ç–µ–º—ã
            return [
                f"–û—Å–Ω–æ–≤—ã {topic}",
                f"–¢–µ–æ—Ä–∏—è {topic}",
                f"–ü—Ä–∞–∫—Ç–∏–∫–∞ –ø–æ {topic}",
                f"–†–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞—á –ø–æ {topic}",
                f"–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ –∏ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ {topic}"
            ]
        else:
            # –û–±—â–∏–µ –ø–æ–¥—Ç–µ–º—ã –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–π —Ç–µ–º—ã
            return ['–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è', '–¢–µ–æ—Ä–∏—è', '–ü—Ä–∞–∫—Ç–∏–∫–∞', '–†–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞—á', '–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ']

    def distribute_study_time(self, subtopics, total_minutes, total_days):
        # –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –º–µ–∂–¥—É –ø–æ–¥—Ç–µ–º–∞–º
        num_subtopics = len(subtopics)
        minutes_per_subtopic = total_minutes // num_subtopics

        plan = []
        current_day = 1

        for i, subtopic in enumerate(subtopics):
            days_for_subtopic = max(1, (minutes_per_subtopic // (total_minutes // total_days)) // 2)

            end_day = min(current_day + days_for_subtopic - 1, total_days)

            plan.append({
                'subtopic': subtopic,
                'days': f"{current_day}-{end_day}",
                'total_minutes': minutes_per_subtopic,
                'daily_minutes': minutes_per_subtopic // days_for_subtopic
            })

            current_day = end_day + 1
            if current_day > total_days:
                break

        return plan

    def format_study_plan(self, plan, subject, topic, exam_date, daily_time, total_days):
        formatted_plan = f"""üìö –ü–ï–†–°–û–ù–ê–õ–¨–ù–´–ô –£–ß–ï–ë–ù–´–ô –ü–õ–ê–ù

üéØ –ü—Ä–µ–¥–º–µ—Ç: {subject}
üìñ –¢–µ–º–∞: {topic}
üìÖ –î–∞—Ç–∞ —ç–∫–∑–∞–º–µ–Ω–∞: {exam_date}
‚è∞ –í—Ä–µ–º—è –≤ –¥–µ–Ω—å: {daily_time} –º–∏–Ω—É—Ç
üìÜ –î–Ω–µ–π –¥–æ —ç–∫–∑–∞–º–µ–Ω–∞: {total_days}

_________________________

–ü–õ–ê–ù –ü–û–î–ì–û–¢–û–í–ö–ò:
"""

        for i, item in enumerate(plan, 1):
            formatted_plan += f"""
{i}. {item['subtopic']}
   üìÖ –î–Ω–∏: {item['days']}
   ‚è± –í—Å–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏: {item['total_minutes']} –º–∏–Ω.
   üéØ –í –¥–µ–Ω—å: ~{item['daily_minutes']} –º–∏–Ω.
"""

        formatted_plan += f"""

_________________________
–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:
‚úÖ –ó–∞–Ω–∏–º–∞–π—Ç–µ—Å—å —Ä–µ–≥—É–ª—è—Ä–Ω–æ
‚úÖ –î–µ–ª–∞–π—Ç–µ –ø–µ—Ä–µ—Ä—ã–≤—ã –∫–∞–∂–¥—ã–µ 45-50 –º–∏–Ω—É—Ç
‚úÖ –ü–æ–≤—Ç–æ—Ä—è–π—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª –≤ –∫–æ–Ω—Ü–µ –∫–∞–∂–¥–æ–π –Ω–µ–¥–µ–ª–∏
‚úÖ –†–µ—à–∞–π—Ç–µ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏
‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

–£–¥–∞—á–∏ –≤ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ! üöÄ"""

        return formatted_plan


# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –ø–ª–∞–Ω–æ–≤
plan_generator = StudyPlanGenerator()


# –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Å –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏
def create_subjects_keyboard():
    keyboard = types.ReplyKeyboardMarkup(row_width=2, resize_keyboard=True)
    subjects = list(SUBJECTS_DATABASE.keys())

    # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≤—Å–µ—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤
    buttons = [types.KeyboardButton(subject) for subject in subjects]

    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø–æ 2 –≤ —Ä—è–¥
    for i in range(0, len(buttons), 2):
        if i + 1 < len(buttons):
            keyboard.add(buttons[i], buttons[i + 1])
        else:
            keyboard.add(buttons[i])

    keyboard.add(types.KeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞"))
    return keyboard


# –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Å –∫–ª–∞—Å—Å–∞–º–∏ –¥–ª—è –ø—Ä–µ–¥–º–µ—Ç–∞
def create_grades_keyboard(subject):
    keyboard = types.ReplyKeyboardMarkup(row_width=3, resize_keyboard=True)
    grades = list(SUBJECTS_DATABASE[subject].keys())

    for grade in grades:
        keyboard.add(types.KeyboardButton(grade))

    keyboard.add(types.KeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ –ø—Ä–µ–¥–º–µ—Ç–∞–º"), types.KeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞"))
    return keyboard


# –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Å —Ç–µ–º–∞–º–∏ –¥–ª—è –∫–ª–∞—Å—Å–∞
def create_topics_keyboard(subject, grade):
    keyboard = types.ReplyKeyboardMarkup(row_width=1, resize_keyboard=True)
    topics = SUBJECTS_DATABASE[subject][grade]

    for topic in topics:
        keyboard.add(types.KeyboardButton(topic))

    keyboard.add(types.KeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ –∫–ª–∞—Å—Å–∞–º"), types.KeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞"))
    return keyboard


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
@bot.message_handler(commands=['start'])
def send_welcome(message):
    welcome_text = """üëã –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç-–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —É—á–µ–±–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤!

–Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ —ç–∫–∑–∞–º–µ–Ω—É.

–ß—Ç–æ —è —É–º–µ—é:
‚Ä¢ –°–æ–∑–¥–∞–≤–∞—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π —É—á–µ–±–Ω—ã–π –ø–ª–∞–Ω
‚Ä¢ –†–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—å –≤—Ä–µ–º—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏
‚Ä¢ –†–∞–∑–±–∏–≤–∞—Ç—å —Ç–µ–º—É –Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –±–ª–æ–∫–∏
‚Ä¢ –£—á–∏—Ç—ã–≤–∞—Ç—å —Ç–≤–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ

üéØ –î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–°–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω" –Ω–∏–∂–µ

–¢–∞–∫–∂–µ —Ç—ã –º–æ–∂–µ—à—å:
/myplan - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–π —Ç–µ–∫—É—â–∏–π –ø–ª–∞–Ω
/help - –ü–æ–ª—É—á–∏—Ç—å —Å–ø—Ä–∞–≤–∫—É"""
    keyboard = types.ReplyKeyboardMarkup(resize_keyboard=True)
    keyboard.add(types.KeyboardButton("üìö –°–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω"))
    bot.send_message(message.chat.id, welcome_text, reply_markup=keyboard)


@bot.message_handler(commands=['help'])
def send_help(message):
    help_text = """üìñ –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–æ—Ç–∞

–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
/start - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º
/myplan - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø–ª–∞–Ω
/help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞

–ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω:
1. –ù–∞–∂–º–∏—Ç–µ "–°–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω"
2. –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –∏–∑ —Å–ø–∏—Å–∫–∞
3. –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å
4. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è
5. –í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É —ç–∫–∑–∞–º–µ–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì
6. –£–∫–∞–∂–∏—Ç–µ, —Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –≤ –¥–µ–Ω—å –≥–æ—Ç–æ–≤ —É–¥–µ–ª—è—Ç—å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ

–ü—Ä–∏–º–µ—Ä:
–ü—Ä–µ–¥–º–µ—Ç: –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞
–ö–ª–∞—Å—Å: 9 –∫–ª–∞—Å—Å  
–¢–µ–º–∞: –ö–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è
–î–∞—Ç–∞: 25.12.2024
–í—Ä–µ–º—è: 60

–ë–æ—Ç —Å–æ–∑–¥–∞—Å—Ç –¥–ª—è —Ç–µ–±—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω! ‚ú®"""
    bot.send_message(message.chat.id, help_text)


@bot.message_handler(commands=['plan'])
def start_plan_creation(message):
    ask_subject(message)


@bot.message_handler(commands=['myplan'])
def show_my_plan(message):
    user_id = str(message.chat.id)
    user_plan = plan_generator.get_user_plan(user_id)

    if user_plan:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç –±–µ–∑ Markdown
        plan_text = f"""üìã –í–ê–® –¢–ï–ö–£–©–ò–ô –ü–õ–ê–ù

üéØ –ü—Ä–µ–¥–º–µ—Ç: {user_plan['subject']}
üìñ –¢–µ–º–∞: {user_plan['topic']}
üìÖ –î–∞—Ç–∞ —ç–∫–∑–∞–º–µ–Ω–∞: {user_plan['exam_date']}
‚è∞ –í—Ä–µ–º—è –≤ –¥–µ–Ω—å: {user_plan['daily_time']} –º–∏–Ω—É—Ç
üïê –°–æ–∑–¥–∞–Ω: {user_plan['created_at']}

_________________________
{user_plan['plan']}"""
        bot.send_message(message.chat.id, plan_text)
    else:
        bot.send_message(message.chat.id,
                         "‚ùå –£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –ø–ª–∞–Ω–∞. –°–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ —Å –ø–æ–º–æ—â—å—é –∫–Ω–æ–ø–∫–∏ '–°–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω'")


# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–°–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω"
@bot.message_handler(func=lambda message: message.text == "üìö –°–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω")
def ask_subject(message):
    bot.send_message(message.chat.id, "üìö –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç:", reply_markup=create_subjects_keyboard())


# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø—Ä–µ–¥–º–µ—Ç–∞
@bot.message_handler(func=lambda message: message.text in SUBJECTS_DATABASE.keys())
def ask_grade(message):
    subject = message.text
    user_id = str(message.chat.id)
    user_data = load_data()

    if user_id not in user_data:
        user_data[user_id] = {}
    user_data[user_id]['subject'] = subject
    save_data(user_data)

    bot.send_message(message.chat.id, f"üìñ –í—ã–±—Ä–∞–Ω –ø—Ä–µ–¥–º–µ—Ç: {subject}\n\n–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å:",
                     reply_markup=create_grades_keyboard(subject))


# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –∫–ª–∞—Å—Å–∞
@bot.message_handler(func=lambda message: any(
    grade in message.text for subject in SUBJECTS_DATABASE.values() for grade in subject.keys()))
def ask_topic(message):
    grade = message.text
    user_id = str(message.chat.id)
    user_data = load_data()

    if user_id in user_data and 'subject' in user_data[user_id]:
        subject = user_data[user_id]['subject']
        user_data[user_id]['grade'] = grade
        save_data(user_data)

        bot.send_message(message.chat.id, f"üéì –í—ã–±—Ä–∞–Ω –∫–ª–∞—Å—Å: {grade}\n\n–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É:",
                         reply_markup=create_topics_keyboard(subject, grade))
    else:
        bot.send_message(message.chat.id, "‚ùå –ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ: /start")


# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–µ–º—ã
@bot.message_handler(func=lambda message: any(
    topic in message.text for subject in SUBJECTS_DATABASE.values() for grade_topics in subject.values() for topic in
    grade_topics))
def ask_exam_date(message):
    topic = message.text
    user_id = str(message.chat.id)
    user_data = load_data()

    if user_id in user_data and 'subject' in user_data[user_id]:
        user_data[user_id]['topic'] = topic
        save_data(user_data)

        # –£–±–∏—Ä–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
        remove_keyboard = types.ReplyKeyboardRemove()
        bot.send_message(message.chat.id,
                         f"üéØ –í—ã–±—Ä–∞–Ω–∞ —Ç–µ–º–∞: {topic}\n\nüìÖ –¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É —ç–∫–∑–∞–º–µ–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì (–Ω–∞–ø—Ä–∏–º–µ—Ä: 25.12.2024):",
                         reply_markup=remove_keyboard)
        bot.register_next_step_handler(message, ask_daily_time)
    else:
        bot.send_message(message.chat.id, "‚ùå –ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ: /start")


def ask_daily_time(message):
    exam_date = message.text
    user_id = str(message.chat.id)
    user_data = load_data()

    try:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞—Ç—ã
        datetime.datetime.strptime(exam_date, '%d.%m.%Y')
        user_data[user_id]['exam_date'] = exam_date
        save_data(user_data)

        bot.send_message(message.chat.id, "‚è∞ –°–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –≤ –¥–µ–Ω—å –≤—ã –≥–æ—Ç–æ–≤—ã —É–¥–µ–ª—è—Ç—å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ? (–Ω–∞–ø—Ä–∏–º–µ—Ä: 60):")
        bot.register_next_step_handler(message, generate_final_plan)

    except ValueError:
        bot.send_message(message.chat.id, "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì. –í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É —Å–Ω–æ–≤–∞:")
        bot.register_next_step_handler(message, ask_daily_time)


def generate_final_plan(message):
    try:
        daily_time = int(message.text)
        if daily_time <= 0:
            bot.send_message(message.chat.id, "‚ùå –í—Ä–µ–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º! –í–≤–µ–¥–∏—Ç–µ —Å–Ω–æ–≤–∞:")
            bot.register_next_step_handler(message, generate_final_plan)
            return

        user_id = str(message.chat.id)
        user_data = load_data()

        if user_id in user_data and all(key in user_data[user_id] for key in ['subject', 'topic', 'exam_date']):
            subject = user_data[user_id]['subject']
            topic = user_data[user_id]['topic']
            exam_date = user_data[user_id]['exam_date']

            # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–ª–∞–Ω–∞
            bot.send_message(message.chat.id, "‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —É—á–µ–±–Ω—ã–π –ø–ª–∞–Ω...")

            study_plan = plan_generator.generate_study_plan(subject, topic, exam_date, daily_time, user_id)

            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
            keyboard = types.ReplyKeyboardMarkup(resize_keyboard=True)
            keyboard.add(types.KeyboardButton("üìö –°–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω"))

            # –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–ª–∞–Ω–∞
            bot.send_message(message.chat.id, study_plan, reply_markup=keyboard)

        else:
            bot.send_message(message.chat.id, "‚ùå –ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫! –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ: /start")

    except ValueError:
        bot.send_message(message.chat.id, "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ! –í–≤–µ–¥–∏—Ç–µ —Å–Ω–æ–≤–∞:")
        bot.register_next_step_handler(message, generate_final_plan)


# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
@bot.message_handler(func=lambda message: message.text in ["‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ –ø—Ä–µ–¥–º–µ—Ç–∞–º", "‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ –∫–ª–∞—Å—Å–∞–º", "‚ùå –û—Ç–º–µ–Ω–∞"])
def handle_navigation(message):
    if message.text == "‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ –ø—Ä–µ–¥–º–µ—Ç–∞–º":
        ask_subject(message)
    elif message.text == "‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ –∫–ª–∞—Å—Å–∞–º":
        user_id = str(message.chat.id)
        user_data = load_data()
        if user_id in user_data and 'subject' in user_data[user_id]:
            subject = user_data[user_id]['subject']
            bot.send_message(message.chat.id, f"üìö –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å –¥–ª—è –ø—Ä–µ–¥–º–µ—Ç–∞ {subject}:",
                             reply_markup=create_grades_keyboard(subject))
        else:
            ask_subject(message)
    elif message.text == "‚ùå –û—Ç–º–µ–Ω–∞":
        keyboard = types.ReplyKeyboardMarkup(resize_keyboard=True)
        keyboard.add(types.KeyboardButton("üìö –°–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω"))
        bot.send_message(message.chat.id, "–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞–Ω–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ. –ß—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å?", reply_markup=keyboard)


# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
@bot.message_handler(func=lambda message: True)
def handle_other_messages(message):
    keyboard = types.ReplyKeyboardMarkup(resize_keyboard=True)
    keyboard.add(types.KeyboardButton("üìö –°–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω"))
    bot.send_message(message.chat.id,
                     "ü§ñ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏–ª–∏ –∫–æ–º–∞–Ω–¥—ã:\n/start - –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É\n/help - —Å–ø—Ä–∞–≤–∫–∞",
                     reply_markup=keyboard)


# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
if not os.path.exists(SUBJECTS_FILE):
    save_subjects_database()

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
if __name__ == '__main__':
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    bot.polling(none_stop=True)